<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NoblekBuilder</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#0f0f0e;--surface:#1a1917;--surface2:#242320;--surface3:#2e2d2a;--border:#2e2d2a;--accent:#e8a020;--text:#f0ede8;--muted:#7a7670;--green:#4caf76;--red:#e05252;--blue:#4a9eff;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;}

/* â”€â”€ PASSWORD SCREEN â”€â”€ */
#pwScreen{display:flex;position:fixed;inset:0;background:var(--bg);z-index:900;align-items:center;justify-content:center;}
#pwScreen.hidden{display:none;}
.pw-box{background:var(--surface);border:1px solid var(--border);padding:40px;width:380px;max-width:95vw;text-align:center;}
.pw-logo{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:30px;letter-spacing:3px;color:var(--accent);margin-bottom:4px;}
.pw-logo span{color:var(--text);}
.pw-sub{font-size:12px;color:var(--muted);margin-bottom:28px;}
.pw-inp{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Barlow',sans-serif;font-size:15px;padding:10px 12px;outline:none;text-align:center;margin-bottom:10px;letter-spacing:2px;}
.pw-inp:focus{border-color:var(--accent);}
.pw-btn{width:100%;background:var(--accent);color:#000;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;letter-spacing:2px;text-transform:uppercase;padding:11px;cursor:pointer;margin-bottom:10px;}
.pw-btn:hover{background:#f5b030;}
.pw-err{font-size:12px;color:var(--red);min-height:16px;}

/* â”€â”€ USERNAME SCREEN â”€â”€ */
#usernameOverlay{display:flex;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:800;align-items:center;justify-content:center;}
#usernameOverlay.hidden{display:none;}
.un-box{background:var(--surface);border:1px solid var(--border);padding:36px;width:380px;max-width:95vw;text-align:center;}
.un-logo{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:30px;letter-spacing:3px;color:var(--accent);margin-bottom:4px;}
.un-logo span{color:var(--text);}
.un-sub{font-size:12px;color:var(--muted);margin-bottom:24px;}
.un-inp{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Barlow',sans-serif;font-size:15px;padding:10px 12px;outline:none;text-align:center;margin-bottom:12px;}
.un-inp:focus{border-color:var(--accent);}
.un-btn{width:100%;background:var(--accent);color:#000;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;letter-spacing:2px;text-transform:uppercase;padding:11px;cursor:pointer;}
.un-btn:hover{background:#f5b030;}
.un-note{font-size:11px;color:var(--muted);margin-top:10px;line-height:1.6;}

/* â”€â”€ DASHBOARD â”€â”€ */
#dashView{display:flex;flex-direction:column;min-height:100vh;}
#dashView.hidden{display:none;}
.dash-header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:56px;}
.logo{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;letter-spacing:2px;color:var(--accent);}
.logo span{color:var(--text);}
.dash-body{flex:1;padding:36px 32px;max-width:1100px;margin:0 auto;width:100%;}
.dash-ttl{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:28px;letter-spacing:1px;margin-bottom:4px;}
.dash-sub{color:var(--muted);font-size:13px;margin-bottom:28px;}
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;}
.proj-card{background:var(--surface);border:1px solid var(--border);padding:18px;cursor:pointer;transition:all .15s;}
.proj-card:hover{border-color:var(--accent);background:var(--surface2);}
.proj-card.mine{border-top:2px solid var(--accent);}
.proj-card.shared{border-top:2px solid var(--blue);}
.pc-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;}
.pc-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:17px;line-height:1.2;}
.pc-badge{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;}
.pc-badge.mine{background:rgba(232,160,32,.15);color:var(--accent);}
.pc-badge.shared{background:rgba(74,158,255,.15);color:var(--blue);}
.pc-date{font-size:11px;color:var(--muted);margin-bottom:10px;}
.pc-total{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;color:var(--accent);}
.pc-total-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.pc-footer{display:flex;align-items:center;justify-content:space-between;margin-top:14px;padding-top:10px;border-top:1px solid var(--border);}
.pc-user{font-size:11px;color:var(--muted);}
.pc-del{background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;padding:3px 6px;}
.pc-del:hover{color:var(--red);}
.new-proj-card{background:none;border:2px dashed var(--border);padding:18px;cursor:pointer;transition:all .15s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-height:160px;color:var(--muted);}
.new-proj-card:hover{border-color:var(--accent);color:var(--accent);}
.new-proj-ico{font-size:28px;}
.new-proj-lbl{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;text-transform:uppercase;}

/* â”€â”€ APP HEADER â”€â”€ */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 18px;display:flex;align-items:center;justify-content:space-between;height:52px;position:sticky;top:0;z-index:100;}
.proj-wrap{display:flex;align-items:center;gap:8px;}
.proj-lbl{font-size:10px;color:var(--muted);font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;text-transform:uppercase;}
.proj-inp{background:none;border:none;border-bottom:1px solid var(--border);color:var(--text);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px;padding:2px 6px;outline:none;width:200px;}
.proj-inp:focus{border-bottom-color:var(--accent);}
.hdr-r{display:flex;align-items:center;gap:7px;}
.as{display:flex;align-items:center;gap:5px;font-family:'Barlow Condensed',sans-serif;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.as-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:background .3s;}
.as-dot.saved{background:var(--green);}
.as-dot.saving{background:var(--accent);animation:blink .6s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;padding:6px 11px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:hover{border-color:var(--accent);color:var(--accent);}
.btn.ac{background:var(--accent);color:#000;border-color:var(--accent);}
.btn.ac:hover{background:#f5b030;}
.btn.gr{background:var(--green);color:#000;border-color:var(--green);}
.btn.gr:hover{background:#5dc988;}
.btn-back{background:none;border:none;color:var(--muted);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;display:flex;align-items:center;gap:5px;padding:4px 8px;}
.btn-back:hover{color:var(--text);}

/* â”€â”€ APP LAYOUT â”€â”€ */
#appView{display:none;flex-direction:column;min-height:100vh;}
#appView.visible{display:flex;}
.app{display:flex;min-height:calc(100vh - 52px);}
.leftnav{width:185px;min-width:185px;background:var(--surface);border-right:1px solid var(--border);padding:16px 0;}
.nav-lbl{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:10px 15px 5px;}
.nav-btn{display:flex;align-items:center;gap:8px;background:none;border:none;color:var(--text);font-family:'Barlow',sans-serif;font-size:13px;padding:8px 15px;text-align:left;cursor:pointer;border-left:3px solid transparent;transition:all .1s;width:100%;}
.nav-btn:hover{background:var(--surface2);color:var(--accent);}
.nav-btn.active{border-left-color:var(--accent);background:var(--surface2);color:var(--accent);font-weight:500;}
.nav-div{border:none;border-top:1px solid var(--border);margin:8px 0;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.tab{display:none;flex:1;overflow-y:auto;padding:20px 24px;}
.tab.active{display:block;}
.sec-ttl{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.sec-sub{font-size:12px;color:var(--muted);margin-bottom:16px;}

/* â”€â”€ ESTIMATE â”€â”€ */
.est-sec{margin-bottom:22px;}
.est-hdr{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;user-select:none;}
.est-hdr:hover{background:var(--surface3);}
.est-hdr-ttl{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
.est-tot{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;color:var(--accent);}
.est-tog{color:var(--muted);font-size:11px;margin-left:8px;}
.est-body{border:1px solid var(--border);border-top:none;}
.est-body.collapsed{display:none;}
.tbl{width:100%;border-collapse:collapse;}
.tbl th{background:var(--bg);padding:6px 10px;text-align:left;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
.tbl td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
.tbl tr:last-child td{border-bottom:none;}
.tbl tr:hover td{background:var(--surface2);}
.ii{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Barlow',sans-serif;font-size:12px;padding:4px 7px;outline:none;width:100%;transition:border-color .15s;}
.ii:focus{border-color:var(--accent);}
.ii.sm{width:58px;text-align:center;}
.ii.pr{width:88px;text-align:right;}
.ii.mu{color:var(--muted);font-size:11px;}
.cell-tot{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;color:var(--text);text-align:right;white-space:nowrap;}
.del{background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;padding:3px;}
.del:hover{color:var(--red);}
.add-row{display:flex;align-items:center;gap:7px;background:none;border:none;border-top:1px dashed var(--border);color:var(--muted);font-family:'Barlow',sans-serif;font-size:12px;padding:8px 12px;cursor:pointer;width:100%;transition:all .1s;}
.add-row:hover{color:var(--accent);background:var(--surface2);}

/* â”€â”€ SUMMARY BAR â”€â”€ */
.sum-bar{background:var(--surface);border-top:2px solid var(--accent);padding:11px 24px;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;}
.sum-item{text-align:center;}
.sum-lbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.sum-val{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:19px;color:var(--text);}
.sum-val.big{color:var(--accent);font-size:25px;}
.sum-div{width:1px;height:34px;background:var(--border);}

/* â”€â”€ CATALOG â”€â”€ */
.srch-row{display:flex;gap:9px;margin-bottom:16px;}
.srch-wrap{flex:1;position:relative;}
.srch-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:14px;}
.srch-inp{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Barlow',sans-serif;font-size:13px;padding:9px 11px 9px 34px;outline:none;transition:border-color .15s;}
.srch-inp:focus{border-color:var(--accent);}
.srch-inp::placeholder{color:var(--muted);}
.flt-sel{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'Barlow',sans-serif;font-size:12px;padding:9px 10px;outline:none;cursor:pointer;}
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(275px,1fr));gap:1px;background:var(--border);}
.cat-card{background:var(--surface);padding:14px;transition:background .1s;border-top:2px solid var(--accent);}
.cat-card:hover{background:var(--surface2);}
.cc-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;margin-bottom:5px;}
.cc-specs{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px;}
.spec{font-size:10px;font-weight:500;padding:2px 6px;background:var(--bg);color:var(--muted);border:1px solid var(--border);}
.cc-price-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.cc-price{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:18px;color:var(--green);}
.cc-unit{font-size:11px;color:var(--muted);}
.cc-url{display:block;font-size:11px;color:var(--blue);text-decoration:none;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cc-url:hover{text-decoration:underline;}
.cc-actions{display:flex;gap:6px;}
.cc-add{flex:1;background:var(--accent);color:#000;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;padding:7px;cursor:pointer;transition:background .1s;}
.cc-add:hover{background:#f5b030;}
.cc-add.added{background:var(--green);}
.cc-del-btn{background:none;border:1px solid var(--border);color:var(--muted);font-size:11px;cursor:pointer;padding:7px 10px;}
.cc-del-btn:hover{border-color:var(--red);color:var(--red);}

/* â”€â”€ SEARCH â”€â”€ */
.psrch-wrap{max-width:640px;}
.psrch-box{display:flex;margin-bottom:16px;}
.psrch-inp{flex:1;background:var(--surface);border:1px solid var(--border);border-right:none;color:var(--text);font-family:'Barlow',sans-serif;font-size:13px;padding:11px 12px;outline:none;}
.psrch-inp:focus{border-color:var(--accent);}
.psrch-inp::placeholder{color:var(--muted);}
.psrch-btn{background:var(--accent);color:#000;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;padding:0 18px;cursor:pointer;}
.psrch-btn:hover{background:#f5b030;}
.ph{background:var(--surface);border:1px solid var(--border);padding:24px;text-align:center;color:var(--muted);font-size:13px;line-height:1.8;}
.res-card{background:var(--surface);border:1px solid var(--border);padding:15px 17px;margin-bottom:8px;}
.rc-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
.rc-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px;}
.rc-src{font-size:10px;color:var(--muted);}
.rc-desc{font-size:12px;color:var(--muted);margin-bottom:8px;line-height:1.5;}
.rc-price{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:21px;color:var(--accent);}
.rc-unit{font-size:11px;color:var(--muted);margin-bottom:6px;}
.rc-note{font-size:11px;color:var(--muted);font-style:italic;margin-bottom:9px;}
.rc-add{background:var(--accent);color:#000;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;padding:6px 13px;cursor:pointer;}
.rc-add:hover{background:#f5b030;}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:14px;}
.chip{background:var(--surface);border:1px solid var(--border);color:var(--muted);font-size:12px;padding:5px 11px;cursor:pointer;transition:all .1s;}
.chip:hover{border-color:var(--accent);color:var(--accent);}
.chip-lbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:7px;}

/* â”€â”€ MODALS â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;align-items:center;justify-content:center;}
.overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);width:450px;max-width:95vw;padding:20px;}
.modal-wide{width:540px;}
.modal-ttl{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:16px;letter-spacing:1px;text-transform:uppercase;margin-bottom:16px;}
.mf{margin-bottom:11px;}
.ml{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;display:block;}
.mi{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Barlow',sans-serif;font-size:13px;padding:7px 9px;outline:none;transition:border-color .15s;}
.mi:focus{border-color:var(--accent);}
.mi-sel{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Barlow',sans-serif;font-size:13px;padding:7px 9px;outline:none;cursor:pointer;}
.mrow{display:flex;gap:9px;}
.mrow .mf{flex:1;}
.mftr{display:flex;justify-content:flex-end;gap:7px;margin-top:16px;}
.m-cancel{background:none;border:1px solid var(--border);color:var(--muted);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;padding:7px 14px;cursor:pointer;}
.m-cancel:hover{color:var(--text);}
.m-save{background:var(--accent);color:#000;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;padding:7px 14px;cursor:pointer;}
.m-save:hover{background:#f5b030;}
.m-danger{background:var(--red);color:#fff;border:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;padding:7px 14px;cursor:pointer;}
.m-danger:hover{background:#f06060;}

/* â”€â”€ DELETE CONFIRM MODAL â”€â”€ */
.del-warn{background:rgba(224,82,82,.08);border:1px solid rgba(224,82,82,.25);padding:10px 12px;font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.6;}
.del-warn strong{color:var(--red);}
.del-name-confirm{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--border);padding:8px 10px;margin-top:6px;display:block;letter-spacing:.5px;}

/* â”€â”€ NEW PROJECT â”€â”€ */
.np-icon-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:4px;}
.np-icon{background:var(--bg);border:1px solid var(--border);padding:8px;text-align:center;font-size:18px;cursor:pointer;transition:all .1s;}
.np-icon:hover,.np-icon.sel{border-color:var(--accent);background:var(--surface2);}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:72px;right:20px;background:var(--green);color:#000;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;padding:8px 15px;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;}
.toast.show{opacity:1;}
.empty{text-align:center;padding:32px;color:var(--muted);font-size:13px;}
.empty-ico{font-size:32px;margin-bottom:8px;}
.loading{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px;padding:40px;justify-content:center;}
.spin{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="pwScreen">
  <div class="pw-box">
    <div class="pw-logo">Noblek<span>Builder</span></div>
    <div class="pw-sub">Entrez le mot de passe pour accÃ©der</div>
    <input class="pw-inp" type="password" id="pwInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="50">
    <button class="pw-btn" onclick="checkPassword()">AccÃ©der â†’</button>
    <div class="pw-err" id="pwErr"></div>
  </div>
</div>

<!-- USERNAME -->
<div id="usernameOverlay" class="hidden">
  <div class="un-box">
    <div class="un-logo">Noblek<span>Builder</span></div>
    <div class="un-sub">Entrez votre nom pour continuer</div>
    <input class="un-inp" type="text" id="unInput" placeholder="Votre prÃ©nom ou pseudo..." maxlength="30">
    <button class="un-btn" onclick="setUsername()">Continuer â†’</button>
    <div class="un-note">Votre nom apparaÃ®tra dans les projets partagÃ©s.</div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashView" class="hidden">
  <div class="dash-header">
    <div class="logo">Noblek<span>Builder</span></div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="dashUser" style="font-size:12px;color:var(--muted);font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;"></span>
      <button class="btn" onclick="document.getElementById('loadFile').click()">ğŸ“‚ Importer .json</button>
      <input type="file" id="loadFile" accept=".json" style="display:none" onchange="importProject(event)">
    </div>
  </div>
  <div class="dash-body">
    <div style="margin-bottom:20px;">
      <div class="dash-ttl">Mes Projets</div>
      <div class="dash-sub">Tous vos estimations, accessibles de n'importe oÃ¹.</div>
    </div>
    <div class="proj-grid" id="projGrid">
      <div class="loading"><div class="spin"></div> Connexion Ã  Firebase...</div>
    </div>
  </div>
</div>

<!-- APP VIEW -->
<div id="appView">
  <header>
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="btn-back" onclick="backToDash()">â† Projets</button>
      <div class="logo" style="font-size:16px;">Noblek<span>Builder</span></div>
      <div class="proj-wrap">
        <span class="proj-lbl">Projet :</span>
        <input class="proj-inp" type="text" id="projName" value="">
      </div>
    </div>
    <div class="hdr-r">
      <div class="as"><div class="as-dot" id="asDot"></div><span id="asLbl">â€”</span></div>
      <button class="btn gr" onclick="exportExcel()">ğŸ“Š Excel</button>
      <button class="btn" onclick="exportCSV()">â¬‡ CSV</button>
      <button class="btn" onclick="saveLocalProject()">ğŸ’¾ Sauvegarder sur l'ordi</button>
    </div>
  </header>

  <div class="app">
    <nav class="leftnav">
      <div class="nav-lbl">Estimation</div>
      <button class="nav-btn active" onclick="switchTab('estimate',this)"><span>ğŸ“Š</span> Estimate Builder</button>
      <hr class="nav-div">
      <div class="nav-lbl">Produits</div>
      <button class="nav-btn" onclick="switchTab('catalog',this)"><span>ğŸ“¦</span> Catalogue</button>
      <button class="nav-btn" onclick="switchTab('search',this)"><span>ğŸ”</span> Recherche</button>
    </nav>

    <div class="main">
      <div class="tab active" id="tab-estimate">
        <div class="sec-ttl">Estimate Builder</div>
        <div class="sec-sub">Tous les coÃ»ts du projet en un seul endroit.</div>
        <div id="est-secs"></div>
        <div style="height:80px"></div>
      </div>

      <div class="tab" id="tab-catalog">
        <div class="sec-ttl">Catalogue de produits</div>
        <div class="sec-sub">Vos produits personnalisÃ©s. Ajoutez-en autant que vous voulez.</div>
        <div class="srch-row">
          <div class="srch-wrap">
            <span class="srch-ico">ğŸ”</span>
            <input class="srch-inp" type="text" id="catSearch" placeholder="Rechercher dans votre catalogue..." oninput="renderCatalog()">
          </div>
          <button class="btn ac" onclick="openCatModal()" style="height:38px">+ Ajouter produit</button>
        </div>
        <div id="catEmpty" style="display:none;" class="empty">
          <div class="empty-ico">ğŸ“¦</div>
          Votre catalogue est vide.<br>
          <button onclick="openCatModal()" style="margin-top:12px;background:var(--accent);color:#000;border:none;padding:7px 14px;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;cursor:pointer">+ Ajouter votre premier produit</button>
        </div>
        <div class="cat-grid" id="catGrid"></div>
      </div>

      <div class="tab" id="tab-search">
        <div class="sec-ttl">Recherche produits</div>
        <div class="sec-sub">Maibec, Canexel, Rockwool, puit artÃ©sien, fosse septique et plus.</div>
        <div class="psrch-wrap">
          <div class="psrch-box">
            <input class="psrch-inp" type="text" id="psrchInp" placeholder="ex: Maibec siding, fosse septique..." onkeydown="if(event.key==='Enter')doSearch()">
            <button class="psrch-btn" onclick="doSearch()">Rechercher</button>
          </div>
          <div id="psrchRes">
            <div class="ph">ğŸ”<br><strong>Recherchez n'importe quel produit de construction</strong><br>Entrez un nom de marque, matÃ©riau ou service.</div>
          </div>
          <div style="margin-top:16px">
            <div class="chip-lbl">Recherches rapides</div>
            <div class="chips">
              <span class="chip" onclick="qs('Maibec siding')">Maibec siding</span>
              <span class="chip" onclick="qs('Canexel cladding')">Canexel</span>
              <span class="chip" onclick="qs('Rockwool insulation')">Rockwool</span>
              <span class="chip" onclick="qs('puit artÃ©sien')">Puit artÃ©sien</span>
              <span class="chip" onclick="qs('fosse septique')">Fosse septique</span>
              <span class="chip" onclick="qs('Velux skylight')">Velux</span>
              <span class="chip" onclick="qs('LVL beam')">Poutre LVL</span>
              <span class="chip" onclick="qs('I-joist')">I-joist</span>
            </div>
          </div>
        </div>
      </div>

      <div class="sum-bar">
        <div class="sum-item"><div class="sum-lbl">MatÃ©riaux</div><div class="sum-val" id="sb-materials">$0</div></div>
        <div class="sum-div"></div>
        <div class="sum-item"><div class="sum-lbl">PrÃ©fab</div><div class="sum-val" id="sb-prefab">$0</div></div>
        <div class="sum-div"></div>
        <div class="sum-item"><div class="sum-lbl">MÃ©tiers</div><div class="sum-val" id="sb-trades">$0</div></div>
        <div class="sum-div"></div>
        <div class="sum-item"><div class="sum-lbl">Site</div><div class="sum-val" id="sb-site">$0</div></div>
        <div class="sum-div"></div>
        <div class="sum-item"><div class="sum-lbl">Sous-traitants</div><div class="sum-val" id="sb-subs">$0</div></div>
        <div class="sum-div"></div>
        <div class="sum-item"><div class="sum-lbl">Total estimÃ©</div><div class="sum-val big" id="sb-total">$0</div></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Nouveau projet -->
<div class="overlay" id="newProjModal">
  <div class="modal modal-wide">
    <div class="modal-ttl">+ Nouveau Projet</div>
    <div class="mf"><label class="ml">Nom du projet *</label><input class="mi" type="text" id="np-name" placeholder="ex: Maison Lac-Beauport, Chalet des Laurentides..."></div>
    <div class="mf">
      <label class="ml">IcÃ´ne</label>
      <div class="np-icon-grid" id="npIconGrid"></div>
    </div>
    <div class="mf">
      <label class="ml">Type de projet</label>
      <select class="mi-sel" id="np-type">
        <option value="Maison neuve">Maison neuve</option>
        <option value="Chalet">Chalet</option>
        <option value="RÃ©novation">RÃ©novation</option>
        <option value="Garage">Garage</option>
        <option value="Commercial">Commercial</option>
        <option value="Autre">Autre</option>
      </select>
    </div>
    <div style="background:var(--bg);border:1px solid var(--border);padding:9px 11px;font-size:11px;color:var(--muted);">
      â˜ï¸ Ce projet sera sauvegardÃ© dans Firebase et accessible par toute l'Ã©quipe.
    </div>
    <div class="mftr">
      <button class="m-cancel" onclick="closeNewProjModal()">Annuler</button>
      <button class="m-save" onclick="createNewProject()">CrÃ©er le projet â†’</button>
    </div>
  </div>
</div>

<!-- MODAL: Supprimer projet (double confirmation) -->
<div class="overlay" id="deleteModal">
  <div class="modal">
    <div class="modal-ttl" style="color:var(--red);">âš  Supprimer le projet</div>
    <div class="del-warn">
      Cette action est <strong>irrÃ©versible</strong>. Toutes les donnÃ©es de ce projet seront dÃ©finitivement supprimÃ©es.<br><br>
      Pour confirmer, tapez le nom du projet ci-dessous :
      <span class="del-name-confirm" id="delProjNameDisplay"></span>
    </div>
    <div class="mf">
      <input class="mi" type="text" id="delConfirmInput" placeholder="Tapez le nom du projet...">
    </div>
    <div class="mftr">
      <button class="m-cancel" onclick="closeDeleteModal()">Annuler</button>
      <button class="m-danger" id="delConfirmBtn" onclick="confirmDeleteProject()" disabled style="opacity:.4;cursor:not-allowed">Supprimer dÃ©finitivement</button>
    </div>
  </div>
</div>

<!-- MODAL: Ajouter item -->
<div class="overlay" id="itemModal">
  <div class="modal">
    <div class="modal-ttl" id="itemModalTtl">Ajouter</div>
    <div class="mf"><label class="ml">Nom *</label><input class="mi" type="text" id="m-name" placeholder="ex: Panneau mur prÃ©fab, Ã‰lectricien..."></div>
    <div class="mf"><label class="ml">Note / SpÃ©cification</label><input class="mi" type="text" id="m-note" placeholder="ex: 2Ã—6 16po OC, forfait complet..."></div>
    <div class="mrow">
      <div class="mf"><label class="ml">QuantitÃ©</label><input class="mi" type="number" id="m-qty" value="1" min="0.01" step="0.01"></div>
      <div class="mf"><label class="ml">UnitÃ©</label><input class="mi" type="text" id="m-unit" placeholder="each, piÂ², forfait..."></div>
      <div class="mf"><label class="ml">Prix unitaire ($)</label><input class="mi" type="number" id="m-price" min="0" step="0.01" placeholder="0.00"></div>
    </div>
    <div class="mftr">
      <button class="m-cancel" onclick="closeItemModal()">Annuler</button>
      <button class="m-save" onclick="saveItem()">Ajouter Ã  l'estimation</button>
    </div>
  </div>
</div>

<!-- MODAL: Ajouter produit catalogue -->
<div class="overlay" id="catModal">
  <div class="modal modal-wide">
    <div class="modal-ttl">â­ Ajouter au catalogue</div>
    <div class="mf"><label class="ml">Nom du produit *</label><input class="mi" type="text" id="cp-name" placeholder="ex: Maibec Cedar 6&quot;, Rockwool R-14..."></div>
    <div class="mf"><label class="ml">SpÃ©cifications <span style="color:var(--muted);font-weight:300;text-transform:none;letter-spacing:0">(sÃ©parÃ©es par virgule)</span></label><input class="mi" type="text" id="cp-specs" placeholder="ex: 8 pi, traitÃ© ACQ, 4Ã—8 ft..."></div>
    <div class="mrow">
      <div class="mf"><label class="ml">Mon prix ($) *</label><input class="mi" type="number" id="cp-price" min="0" step="0.01" placeholder="0.00"></div>
      <div class="mf"><label class="ml">UnitÃ©</label><input class="mi" type="text" id="cp-unit" placeholder="each, piÂ², feuille..."></div>
    </div>
    <div class="mf">
      <label class="ml">URL du produit <span style="color:var(--muted);font-weight:300;text-transform:none;letter-spacing:0">(optionnel â€” lien vers le site du fournisseur)</span></label>
      <input class="mi" type="url" id="cp-url" placeholder="https://www.homedepot.ca/product/...">
    </div>
    <div class="mf">
      <label class="ml">CatÃ©gorie</label>
      <select class="mi-sel" id="cp-cat">
        <option value="custom">â­ Mes produits</option>
        <option value="framing">Charpente</option>
        <option value="sheathing">Panneaux</option>
        <option value="roofing">Toiture</option>
        <option value="concrete">BÃ©ton & MaÃ§onnerie</option>
        <option value="insulation">Isolation</option>
        <option value="fasteners">Fixations</option>
        <option value="exterior">RevÃªtement extÃ©rieur</option>
        <option value="mechanical">MÃ©canique</option>
        <option value="other">Autre</option>
      </select>
    </div>
    <div class="mftr">
      <button class="m-cancel" onclick="closeCatModal()">Annuler</button>
      <button class="m-save" onclick="saveCatProduct()">Sauvegarder dans le catalogue</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxmD5HlKOgW5zwkftSVHr-xHrOlLXU6ek",
  authDomain: "noblek-builder.firebaseapp.com",
  projectId: "noblek-builder",
  storageBucket: "noblek-builder.firebasestorage.app",
  messagingSenderId: "105785616325",
  appId: "1:105785616325:web:de8cf5d24046a0c19bcdac"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window._fb = {
  async getProjects(){
    try{const snap=await getDocs(collection(db,'projects'));return snap.docs.map(d=>d.data());}
    catch(e){console.error(e);return[];}
  },
  async getProject(id){
    try{const snap=await getDoc(doc(db,'projects',id));return snap.exists()?snap.data():null;}
    catch(e){console.error(e);return null;}
  },
  async saveProject(id,data){
    try{await setDoc(doc(db,'projects',id),data);return true;}
    catch(e){console.error(e);return false;}
  },
  async deleteProject(id){
    try{await deleteDoc(doc(db,'projects',id));return true;}
    catch(e){console.error(e);return false;}
  }
};

window.dispatchEvent(new Event('firebase-ready'));
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸ CHANGE THIS PASSWORD â€” c'est votre mot de passe d'accÃ¨s
const APP_PASSWORD = 'noblek2024';

function checkPassword(){
  const val = document.getElementById('pwInput').value;
  if(val === APP_PASSWORD){
    sessionStorage.setItem('noblek_auth','1');
    document.getElementById('pwScreen').classList.add('hidden');
    initAfterAuth();
  } else {
    const err = document.getElementById('pwErr');
    err.textContent = 'Mot de passe incorrect. RÃ©essayez.';
    document.getElementById('pwInput').value = '';
    document.getElementById('pwInput').focus();
    setTimeout(()=>err.textContent='', 3000);
  }
}
document.getElementById('pwInput').addEventListener('keydown',e=>{if(e.key==='Enter')checkPassword();});

function initAfterAuth(){
  const saved = localStorage.getItem('noblek_user');
  if(saved){
    currentUser = saved;
    document.getElementById('dashUser').textContent = 'ğŸ‘¤ '+saved;
    document.getElementById('dashView').classList.remove('hidden');
    if(firebaseReady) renderDash();
  } else {
    document.getElementById('usernameOverlay').classList.remove('hidden');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SEARCH_DB={
  'maibec':[{name:'Maibec Siding â€” Cedar Bevel',desc:'Bardage en cÃ¨dre vÃ©ritable, profils 6", 8" ou 10".',price:4.25,unit:'pi linÃ©aire',note:'Prix estimÃ© â€” vÃ©rifier avec reprÃ©sentant Maibec'}],
  'canexel':[{name:'Canexel â€” RevÃªtement composite',desc:'Fibres de bois compressÃ©es. Faible entretien.',price:3.80,unit:'piÂ²',note:'Prix estimÃ©. Commander via distributeur agrÃ©Ã©.'}],
  'rockwool':[{name:'Rockwool Comfortbatt R-14',desc:'Laine de roche pour murs 2Ã—4, 16" OC.',price:79.99,unit:'paquet (40 piÂ²)',note:'Disponible Home Depot CA et RONA'}],
  'puit':[{name:'Puit artÃ©sien â€” forage complet',desc:'Forage + tubage + pompe submersible + raccordement.',price:15000,unit:'forfait',note:'Prix moyen QuÃ©bec 2024. Obtenir 3 soumissions.'}],
  'fosse':[
    {name:'Fosse septique 3 000 gallons',desc:'BÃ©ton 3 chambres, installation complÃ¨te.',price:18000,unit:'forfait',note:'Varie selon terrain. Permis municipal requis.'},
    {name:'Fosse septique 4 500 gallons',desc:'Pour maison de 4 chambres+.',price:24000,unit:'forfait',note:'Inclut gÃ©nÃ©ralement les permis municipaux'},
  ],
  'velux':[{name:'Velux FCM â€” Puit de lumiÃ¨re 22Ã—46"',desc:'Fixe, verre trempÃ© Low-E.',price:549,unit:'each',note:'Installation non incluse (~400â€“600$ extra)'}],
  'i-joist':[
    {name:'I-Joist TJI 110 â€” 9.5"',desc:'Solive en I engineerÃ©e. PortÃ©e jusqu\'Ã  18 pi.',price:26.50,unit:'each',note:'Disponible Canac et Home Depot CA'},
    {name:'I-Joist TJI 210 â€” 11.875"',desc:'Solive en I grande portÃ©e.',price:34.80,unit:'each',note:'Commander avec liste de coupe'},
  ],
  'lvl':[{name:'Poutre LVL 3.5Ã—9.5" â€” 16 pi',desc:'LamellÃ©e collÃ©e. Usage structurel.',price:189,unit:'each',note:'En stock chez Canac et Home Depot CA'}],
};

const SECS=[
  {key:'materials',label:'MatÃ©riaux',icon:'ğŸªµ'},
  {key:'prefab',label:'Composantes PrÃ©fab',icon:'ğŸ—ï¸'},
  {key:'trades',label:'MÃ©tiers & Services',icon:'ğŸ”§'},
  {key:'site',label:'Services de Site',icon:'ğŸŒ'},
  {key:'subs',label:'Sous-traitants',icon:'ğŸ“‹'},
];

const PROJ_ICONS=['ğŸ ','ğŸ¡','ğŸ—ï¸','ğŸ˜ï¸','ğŸŒ²','â›º','ğŸ¢','ğŸ”¨','ğŸªš','ğŸ›ï¸','ğŸŒ¿','ğŸ”ï¸'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser='';
let currentProjectId=null;
let estimate={materials:[],prefab:[],trades:[],site:[],subs:[]};
let activeSec='';
let selectedIcon='ğŸ ';
let deleteTargetId=null;
let deleteTargetName='';
let firebaseReady=false;
const CK='buildcat_v3_catalog';

function uid(){return Math.random().toString(36).slice(2,10);}
function fmt(n){return n.toLocaleString('fr-CA',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmts(n){return n.toLocaleString('fr-CA',{maximumFractionDigits:0});}
function esc(s){return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;');}
function grandTotal(){return SECS.reduce((a,s)=>a+estimate[s.key].reduce((b,i)=>b+(i.qty||0)*(i.price||0),0),0);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE READY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('firebase-ready',()=>{
  firebaseReady=true;
  // If already authenticated and user set, load dashboard
  if(sessionStorage.getItem('noblek_auth')==='1' && currentUser){
    renderDash();
  }
  // Auto-hide password screen if already authenticated this session
  if(sessionStorage.getItem('noblek_auth')==='1'){
    document.getElementById('pwScreen').classList.add('hidden');
    initAfterAuth();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERNAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setUsername(){
  const v=document.getElementById('unInput').value.trim();
  if(!v) return;
  currentUser=v;
  localStorage.setItem('noblek_user',v);
  document.getElementById('usernameOverlay').classList.add('hidden');
  document.getElementById('dashUser').textContent='ğŸ‘¤ '+v;
  document.getElementById('dashView').classList.remove('hidden');
  if(firebaseReady) renderDash();
}
document.getElementById('unInput').addEventListener('keydown',e=>{if(e.key==='Enter')setUsername();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDash(){
  const grid=document.getElementById('projGrid');
  grid.innerHTML='<div class="loading"><div class="spin"></div> Chargement des projets...</div>';
  const projects=await window._fb.getProjects();
  projects.sort((a,b)=>new Date(b.updatedAt||0)-new Date(a.updatedAt||0));

  let html=`<div class="new-proj-card" onclick="openNewProjModal()">
    <div class="new-proj-ico">+</div>
    <div class="new-proj-lbl">Nouveau Projet</div>
  </div>`;

  for(const p of projects){
    const isOwner=p.owner===currentUser;
    const dateStr=p.updatedAt?new Date(p.updatedAt).toLocaleDateString('fr-CA'):'â€”';
    html+=`<div class="proj-card ${isOwner?'mine':'shared'}" onclick="openProject('${p.id}')">
      <div class="pc-top">
        <div class="pc-name">${p.icon||'ğŸ '} ${esc(p.name)}</div>
        <span class="pc-badge ${isOwner?'mine':'shared'}">${isOwner?'Mon projet':'PartagÃ©'}</span>
      </div>
      <div class="pc-date">ModifiÃ© : ${dateStr}${p.lastEditBy?' par '+esc(p.lastEditBy):''}</div>
      <div class="pc-total-lbl">Total estimÃ©</div>
      <div class="pc-total">$${fmts(p.total||0)}</div>
      <div class="pc-footer">
        <span class="pc-user">ğŸ“ ${esc(p.type||'Projet')} Â· ${esc(p.owner||'')}</span>
        ${isOwner?`<button class="pc-del" onclick="event.stopPropagation();openDeleteModal('${p.id}','${p.name.replace(/'/g,"\\'")}')">âœ• Supprimer</button>`:''}
      </div>
    </div>`;
  }
  grid.innerHTML=html;
}

async function openProject(projId){
  const dot=document.getElementById('asDot'),lbl=document.getElementById('asLbl');
  dot.className='as-dot saving'; lbl.textContent='Chargementâ€¦';
  const data=await window._fb.getProject(projId);
  if(!data){showToast('âŒ Projet introuvable');dot.className='as-dot';lbl.textContent='â€”';return;}
  currentProjectId=projId;
  estimate={materials:[],prefab:[],trades:[],site:[],subs:[],...(data.estimate||{})};
  document.getElementById('projName').value=data.name||'Sans titre';
  document.getElementById('dashView').classList.add('hidden');
  document.getElementById('appView').classList.add('visible');
  buildSections();
  renderAll();
  dot.className='as-dot saved'; lbl.textContent='Firebase âœ“';
  showToast('âœ“ "'+data.name+'" ouvert');
}

function backToDash(){
  currentProjectId=null;
  document.getElementById('appView').classList.remove('visible');
  document.getElementById('dashView').classList.remove('hidden');
  renderDash();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE MODAL (double confirm)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDeleteModal(projId, projName){
  deleteTargetId=projId;
  deleteTargetName=projName;
  document.getElementById('delProjNameDisplay').textContent=projName;
  document.getElementById('delConfirmInput').value='';
  const btn=document.getElementById('delConfirmBtn');
  btn.disabled=true; btn.style.opacity='.4'; btn.style.cursor='not-allowed';
  document.getElementById('deleteModal').classList.add('open');
  setTimeout(()=>document.getElementById('delConfirmInput').focus(),50);
}

function closeDeleteModal(){
  document.getElementById('deleteModal').classList.remove('open');
  deleteTargetId=null; deleteTargetName='';
}

document.getElementById('delConfirmInput').addEventListener('input',function(){
  const btn=document.getElementById('delConfirmBtn');
  const match=this.value.trim()===deleteTargetName;
  btn.disabled=!match;
  btn.style.opacity=match?'1':'.4';
  btn.style.cursor=match?'pointer':'not-allowed';
});

async function confirmDeleteProject(){
  if(!deleteTargetId) return;
  await window._fb.deleteProject(deleteTargetId);
  closeDeleteModal();
  showToast('Projet supprimÃ©');
  renderDash();
}

document.getElementById('deleteModal').addEventListener('click',e=>{if(e.target.id==='deleteModal')closeDeleteModal();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW PROJECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildIconGrid(){
  document.getElementById('npIconGrid').innerHTML=PROJ_ICONS.map(ico=>`
    <div class="np-icon ${ico===selectedIcon?'sel':''}" onclick="selectIcon('${ico}')">${ico}</div>
  `).join('');
}
function selectIcon(ico){selectedIcon=ico;buildIconGrid();}
function openNewProjModal(){
  selectedIcon='ğŸ ';
  document.getElementById('np-name').value='';
  buildIconGrid();
  document.getElementById('newProjModal').classList.add('open');
  setTimeout(()=>document.getElementById('np-name').focus(),50);
}
function closeNewProjModal(){document.getElementById('newProjModal').classList.remove('open');}

async function createNewProject(){
  const name=document.getElementById('np-name').value.trim();
  if(!name){document.getElementById('np-name').focus();return;}
  const type=document.getElementById('np-type').value;
  const projId='proj-'+uid();
  const now=new Date().toISOString();
  const projData={id:projId,name,icon:selectedIcon,type,owner:currentUser,createdAt:now,updatedAt:now,lastEditBy:currentUser,total:0,estimate:{materials:[],prefab:[],trades:[],site:[],subs:[]}};
  const ok=await window._fb.saveProject(projId,projData);
  if(!ok){showToast('âŒ Erreur Firebase');return;}
  closeNewProjModal();
  showToast('âœ“ Projet "'+name+'" crÃ©Ã©!');
  openProject(projId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT .json
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importProject(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      if(!d.estimate) throw new Error();
      const projId='proj-'+uid();
      const name=d.name||'Projet importÃ©';
      const now=new Date().toISOString();
      const total=SECS.reduce((a,s)=>a+(d.estimate[s.key]||[]).reduce((b,i)=>b+(i.qty||0)*(i.price||0),0),0);
      const projData={id:projId,name,icon:'ğŸ“‚',type:'ImportÃ©',owner:currentUser,createdAt:now,updatedAt:now,lastEditBy:currentUser,total,estimate:{materials:[],prefab:[],trades:[],site:[],subs:[],...d.estimate}};
      await window._fb.saveProject(projId,projData);
      showToast('âœ“ "'+name+'" importÃ©!');
      renderDash();
    }catch(err){alert('Fichier invalide.');}
  };
  reader.readAsText(file);
  e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE TO FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let saveTimer=null;
async function triggerSaveDirect(){
  const dot=document.getElementById('asDot'),lbl=document.getElementById('asLbl');
  dot.className='as-dot saving'; lbl.textContent='Sauvegardeâ€¦';
  clearTimeout(saveTimer);
  saveTimer=setTimeout(async()=>{
    if(!currentProjectId) return;
    const name=document.getElementById('projName').value||'Sans titre';
    const now=new Date().toISOString();
    const total=grandTotal();
    const existing=await window._fb.getProject(currentProjectId)||{};
    const projData={...existing,id:currentProjectId,name,updatedAt:now,lastEditBy:currentUser,total,estimate};
    const ok=await window._fb.saveProject(currentProjectId,projData);
    dot.className='as-dot saved'; lbl.textContent=ok?'Firebase âœ“':'Erreur';
  },900);
}

document.getElementById('projName').addEventListener('input',()=>{if(currentProjectId) triggerSaveDirect();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE TO LOCAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveLocalProject(){
  const name=document.getElementById('projName').value||'Projet';
  const d={name,savedAt:new Date().toISOString(),estimate};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
  a.download=(name.replace(/\s+/g,'-')||'projet')+'.buildcat.json';
  a.click();
  showToast('âœ“ SauvegardÃ© sur l\'ordi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id,btn){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  btn.classList.add('active');
  if(id==='catalog') renderCatalog();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTIMATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSections(){
  document.getElementById('est-secs').innerHTML=SECS.map(s=>`
    <div class="est-sec">
      <div class="est-hdr" onclick="toggleSec('${s.key}')">
        <div class="est-hdr-ttl">${s.icon} ${s.label}</div>
        <div style="display:flex;align-items:center">
          <div class="est-tot" id="etot-${s.key}">$0.00</div>
          <span class="est-tog" id="etog-${s.key}">â–¼</span>
        </div>
      </div>
      <div class="est-body" id="ebody-${s.key}">
        <table class="tbl">
          <thead><tr>
            <th style="width:32%">Item</th><th style="width:22%">Note / SpÃ©c</th>
            <th style="width:9%">QtÃ©</th><th style="width:10%">UnitÃ©</th>
            <th style="width:13%">Prix unit. ($)</th><th style="width:11%;text-align:right">Total</th>
            <th style="width:3%"></th>
          </tr></thead>
          <tbody id="tbody-${s.key}"></tbody>
        </table>
        <button class="add-row" onclick="openItemModal('${s.key}')">+ Ajouter</button>
      </div>
    </div>`).join('');
}

function toggleSec(k){
  const b=document.getElementById('ebody-'+k),t=document.getElementById('etog-'+k);
  b.classList.toggle('collapsed');
  t.textContent=b.classList.contains('collapsed')?'â–¶':'â–¼';
}

function renderSec(k){
  const items=estimate[k];
  const tbody=document.getElementById('tbody-'+k);
  const icon=SECS.find(s=>s.key===k)?.icon||'ğŸ“¦';
  if(!items.length){
    tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-ico">${icon}</div>Aucun Ã©lÃ©ment. Cliquez + Ajouter.</div></td></tr>`;
    document.getElementById('etot-'+k).textContent='$0.00';
    return;
  }
  tbody.innerHTML=items.map(item=>{
    const tot=(item.qty||0)*(item.price||0);
    return `<tr>
      <td><input class="ii" value="${esc(item.name)}" onchange="upd('${k}','${item.id}','name',this.value)"></td>
      <td><input class="ii mu" value="${esc(item.note)}" placeholder="Note..." onchange="upd('${k}','${item.id}','note',this.value)"></td>
      <td><input class="ii sm" type="number" min="0" step="0.01" value="${item.qty}" onchange="upd('${k}','${item.id}','qty',parseFloat(this.value)||0)"></td>
      <td><input class="ii" value="${esc(item.unit)}" placeholder="unit" style="width:68px" onchange="upd('${k}','${item.id}','unit',this.value)"></td>
      <td><input class="ii pr" type="number" min="0" step="0.01" value="${item.price||''}" placeholder="0.00" onchange="upd('${k}','${item.id}','price',parseFloat(this.value)||0)"></td>
      <td class="cell-tot" id="rt-${item.id}">$${fmt(tot)}</td>
      <td><button class="del" onclick="delItem('${k}','${item.id}')">âœ•</button></td>
    </tr>`;
  }).join('');
  document.getElementById('etot-'+k).textContent='$'+fmt(items.reduce((a,i)=>a+(i.qty||0)*(i.price||0),0));
}

function renderAll(){SECS.forEach(s=>renderSec(s.key));updateSummary();}

function upd(k,id,field,val){
  const item=estimate[k].find(i=>i.id===id); if(!item) return;
  item[field]=val;
  const tot=(item.qty||0)*(item.price||0);
  const el=document.getElementById('rt-'+id); if(el) el.textContent='$'+fmt(tot);
  document.getElementById('etot-'+k).textContent='$'+fmt(estimate[k].reduce((a,i)=>a+(i.qty||0)*(i.price||0),0));
  updateSummary(); triggerSaveDirect();
}

function delItem(k,id){
  estimate[k]=estimate[k].filter(i=>i.id!==id);
  renderSec(k); updateSummary(); triggerSaveDirect();
}

function updateSummary(){
  let grand=0;
  SECS.forEach(s=>{
    const t=estimate[s.key].reduce((a,i)=>a+(i.qty||0)*(i.price||0),0);
    grand+=t;
    document.getElementById('sb-'+s.key).textContent='$'+fmts(t);
  });
  document.getElementById('sb-total').textContent='$'+fmts(grand);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEM MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODAL_TTL={materials:'Ajouter un matÃ©riau',prefab:'Ajouter une composante prÃ©fab',trades:'Ajouter un mÃ©tier / service',site:'Ajouter un service de site',subs:'Ajouter un sous-traitant'};
const MODAL_UNIT={materials:'each',prefab:'forfait',trades:'forfait',site:'forfait',subs:'forfait'};

function openItemModal(k){
  activeSec=k;
  document.getElementById('itemModalTtl').textContent=MODAL_TTL[k]||'Ajouter';
  ['m-name','m-note'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('m-qty').value=1;
  document.getElementById('m-unit').value=MODAL_UNIT[k]||'each';
  document.getElementById('m-price').value='';
  document.getElementById('itemModal').classList.add('open');
  setTimeout(()=>document.getElementById('m-name').focus(),50);
}
function closeItemModal(){document.getElementById('itemModal').classList.remove('open');}

function saveItem(){
  const name=document.getElementById('m-name').value.trim();
  if(!name){document.getElementById('m-name').focus();return;}
  estimate[activeSec].push({
    id:uid(),name,
    note:document.getElementById('m-note').value.trim(),
    qty:parseFloat(document.getElementById('m-qty').value)||1,
    unit:document.getElementById('m-unit').value.trim()||'each',
    price:parseFloat(document.getElementById('m-price').value)||0,
  });
  renderSec(activeSec); updateSummary(); triggerSaveDirect();
  closeItemModal();
  showToast('âœ“ '+name+' ajoutÃ©');
}
document.getElementById('itemModal').addEventListener('click',e=>{if(e.target.id==='itemModal')closeItemModal();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATALOG (custom only, with URL)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCustom(){try{return JSON.parse(localStorage.getItem(CK))||[];}catch(e){return[];}}
function setCustom(a){localStorage.setItem(CK,JSON.stringify(a));}

function openCatModal(){
  ['cp-name','cp-specs','cp-unit','cp-url'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cp-price').value='';
  document.getElementById('cp-cat').value='custom';
  document.getElementById('catModal').classList.add('open');
  setTimeout(()=>document.getElementById('cp-name').focus(),50);
}
function closeCatModal(){document.getElementById('catModal').classList.remove('open');}

function saveCatProduct(){
  const name=document.getElementById('cp-name').value.trim();
  const price=parseFloat(document.getElementById('cp-price').value);
  if(!name){document.getElementById('cp-name').focus();return;}
  if(isNaN(price)||price<0){document.getElementById('cp-price').focus();return;}
  const raw=document.getElementById('cp-specs').value.trim();
  const url=document.getElementById('cp-url').value.trim();
  const p={
    id:'c-'+uid(),name,
    specs:raw?raw.split(',').map(s=>s.trim()).filter(Boolean):[],
    unit:document.getElementById('cp-unit').value.trim()||'each',
    cat:document.getElementById('cp-cat').value,
    price,
    url:url||'',
    isCustom:true,
    createdAt:new Date().toISOString(),
  };
  const arr=getCustom(); arr.unshift(p); setCustom(arr);
  closeCatModal(); renderCatalog();
  showToast('â­ "'+name+'" ajoutÃ© au catalogue');
}

function deleteCustom(id){
  setCustom(getCustom().filter(p=>p.id!==id));
  renderCatalog();
  showToast('Produit retirÃ© du catalogue');
}

document.getElementById('catModal').addEventListener('click',e=>{if(e.target.id==='catModal')closeCatModal();});

function renderCatalog(){
  const q=(document.getElementById('catSearch').value||'').toLowerCase().trim();
  const custom=getCustom();
  const filtered=custom.filter(p=>{
    if(!q) return true;
    const hay=[p.name,...(p.specs||[]),(p.cat||'')].join(' ').toLowerCase();
    return q.split(' ').every(w=>hay.includes(w));
  });

  const grid=document.getElementById('catGrid');
  const empty=document.getElementById('catEmpty');

  if(custom.length===0){
    grid.innerHTML='';
    empty.style.display='block';
    return;
  }
  empty.style.display='none';

  if(filtered.length===0){
    grid.innerHTML=`<div class="empty" style="grid-column:1/-1"><div class="empty-ico">ğŸ”</div>Aucun produit trouvÃ© pour "${q}".</div>`;
    return;
  }

  grid.innerHTML=filtered.map(p=>`
    <div class="cat-card">
      <div class="cc-name">â­ ${esc(p.name)}</div>
      <div class="cc-specs">${(p.specs||[]).map(s=>`<span class="spec">${esc(s)}</span>`).join('')}</div>
      <div class="cc-price-row">
        <span class="cc-price">$${p.price.toFixed(2)}</span>
        <span class="cc-unit">/ ${esc(p.unit)}</span>
      </div>
      ${p.url?`<a class="cc-url" href="${esc(p.url)}" target="_blank" rel="noopener">ğŸ”— ${esc(p.url)}</a>`:''}
      <div class="cc-actions">
        <button class="cc-add" id="ccb-${p.id}" onclick="addCustomToEst('${p.id}')">+ Ajouter Ã  l'estimation</button>
        <button class="cc-del-btn" onclick="deleteCustom('${p.id}')">âœ•</button>
      </div>
    </div>`).join('');
}

function addCustomToEst(pid){
  const p=getCustom().find(x=>x.id===pid); if(!p) return;
  estimate.materials.push({id:uid(),name:p.name,note:(p.specs||[]).join(', '),qty:1,unit:p.unit,price:p.price});
  renderSec('materials'); updateSummary(); triggerSaveDirect();
  const b=document.getElementById('ccb-'+pid); if(b){b.textContent='âœ“ AjoutÃ©';b.classList.add('added');setTimeout(()=>{b.textContent="+ Ajouter Ã  l'estimation";b.classList.remove('added');},2000);}
  showToast('âœ“ '+p.name+' ajoutÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function qs(q){document.getElementById('psrchInp').value=q;doSearch();}

function doSearch(){
  const raw=document.getElementById('psrchInp').value.trim().toLowerCase();
  if(!raw) return;
  const el=document.getElementById('psrchRes');
  let matches=[];
  for(const key in SEARCH_DB){if(raw.includes(key)||key.split(' ').some(w=>raw.includes(w))) matches.push(...SEARCH_DB[key]);}
  if(!matches.length){el.innerHTML=`<div class="ph">ğŸ”<br><strong>Aucun rÃ©sultat pour "${raw}"</strong></div>`;return;}
  el.innerHTML=matches.map(r=>`
    <div class="res-card">
      <div class="rc-hd"><div class="rc-name">${esc(r.name)}</div><span class="rc-src">Prix estimÃ©</span></div>
      <div class="rc-desc">${esc(r.desc)}</div>
      <div class="rc-price">$${r.price.toLocaleString('fr-CA',{minimumFractionDigits:2})}</div>
      <div class="rc-unit">/ ${esc(r.unit)}</div>
      <div class="rc-note">âš  ${esc(r.note)}</div>
      <button class="rc-add" onclick="addSearchRes('${r.name.replace(/'/g,"\\'")}',${r.price},'${r.unit.replace(/'/g,"\\'")}')">+ Ajouter Ã  l'estimation</button>
    </div>`).join('');
}

function addSearchRes(name,price,unit){
  const nl=name.toLowerCase();
  let sec='materials';
  if(/puit|fosse|driveway|entrÃ©e|excavation/.test(nl)) sec='site';
  else if(/Ã©lectricien|plombier|hvac|cvc/.test(nl)) sec='trades';
  estimate[sec].push({id:uid(),name,note:'Prix estimÃ© â€” Ã  confirmer',qty:1,unit,price});
  renderSec(sec); updateSummary(); triggerSaveDirect();
  switchTab('estimate',document.querySelector('.nav-btn'));
  document.querySelector('.nav-btn').classList.add('active');
  showToast('âœ“ '+name+' ajoutÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel(){
  const proj=document.getElementById('projName').value||'Projet';
  const wb=XLSX.utils.book_new();
  const rows=[];
  rows.push([proj]);
  rows.push(['Estimation de construction â€” NoblekBuilder']);
  rows.push(['Date:',new Date().toLocaleDateString('fr-CA')]);
  rows.push([]);
  let r=5; const subRefs=[];
  const DEFS=[{key:'materials',label:'MATÃ‰RIAUX'},{key:'prefab',label:'COMPOSANTES PRÃ‰FAB'},{key:'trades',label:'MÃ‰TIERS & SERVICES'},{key:'site',label:'SERVICES DE SITE'},{key:'subs',label:'SOUS-TRAITANTS'}];
  DEFS.forEach(def=>{
    const items=estimate[def.key]; if(!items.length) return;
    rows.push([def.label]); r++;
    rows.push(['Item / Description','Note / SpÃ©cification','QtÃ©','UnitÃ©','Prix unitaire ($)','Total ($)']); r++;
    const ds=r;
    items.forEach(item=>{rows.push([item.name,item.note||'',item.qty||0,item.unit||'',item.price||0,{f:`C${r}*E${r}`}]);r++;});
    rows.push(['','','','','SOUS-TOTAL',{f:`SUM(F${ds}:F${r-1})`}]);
    subRefs.push(`F${r}`); r++; rows.push([]); r++;
  });
  rows.push([]); rows.push(['','','','','TOTAL ESTIMÃ‰',{f:subRefs.join('+')}]);
  const ws=XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:36},{wch:30},{wch:8},{wch:10},{wch:17},{wch:16}];
  XLSX.utils.book_append_sheet(wb,ws,'Estimation');
  XLSX.writeFile(wb,proj.replace(/\s+/g,'-')+'-estimation.xlsx');
  showToast('âœ“ Excel exportÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(){
  const proj=document.getElementById('projName').value||'Projet';
  let csv=`Projet: ${proj}\nDate: ${new Date().toLocaleDateString('fr-CA')}\n\n`;
  let grand=0;
  SECS.forEach(s=>{
    const items=estimate[s.key]; if(!items.length) return;
    const tot=items.reduce((a,i)=>a+(i.qty||0)*(i.price||0),0); grand+=tot;
    csv+=`\n${s.label.toUpperCase()}\n`;
    csv+='Item,Note,QtÃ©,UnitÃ©,Prix unitaire,Total\n';
    items.forEach(i=>csv+=`"${i.name}","${i.note||''}",${i.qty},"${i.unit||''}","$${(i.price||0).toFixed(2)}","$${((i.qty||0)*(i.price||0)).toFixed(2)}"\n`);
    csv+=`,,,,SOUS-TOTAL,"$${tot.toFixed(2)}"\n`;
  });
  csv+=`\n\nTOTAL ESTIMÃ‰,,,,,"$${grand.toFixed(2)}"\n`;
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download=proj.replace(/\s+/g,'-')+'-estimation.csv';
  a.click();
  showToast('âœ“ CSV exportÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.classList.remove('show'),2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeItemModal();closeCatModal();closeNewProjModal();closeDeleteModal();}
  if(e.key==='Enter'){
    if(document.getElementById('itemModal').classList.contains('open')) saveItem();
    if(document.getElementById('catModal').classList.contains('open')) saveCatProduct();
    if(document.getElementById('newProjModal').classList.contains('open')) createNewProject();
  }
});
</script>
</body>
</html>
